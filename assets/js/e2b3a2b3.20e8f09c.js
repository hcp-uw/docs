"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9823],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),u=a,m=d["".concat(s,".").concat(u)]||d[u]||h[u]||r;return n?o.createElement(m,i(i({ref:t},p),{},{components:n})):o.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6278:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var o=n(7462),a=(n(7294),n(3905));const r={sidebar_position:1},i="Local Development",l={unversionedId:"tech/ML/training/Local",id:"tech/ML/training/Local",title:"Local Development",description:"Setup",source:"@site/docs/tech/ML/training/Local.md",sourceDirName:"tech/ML/training",slug:"/tech/ML/training/Local",permalink:"/tech/ML/training/Local",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Training",permalink:"/category/training"},next:{title:"Google Colab",permalink:"/tech/ML/training/Colab"}},s={},c=[{value:"Setup",id:"setup",level:2},{value:"Installing Python",id:"installing-python",level:3},{value:"Windows",id:"windows",level:4},{value:"macOS",id:"macos",level:4},{value:"Linux",id:"linux",level:4},{value:"Copying Code",id:"copying-code",level:3},{value:"Setting up a virtual environment",id:"setting-up-a-virtual-environment",level:3},{value:"Windows",id:"windows-1",level:4},{value:"macOS / Linux",id:"macos--linux",level:4},{value:"Windows",id:"windows-2",level:4},{value:"macOS / Linux",id:"macos--linux-1",level:4},{value:"Training",id:"training",level:2},{value:"Saving Model",id:"saving-model",level:3},{value:"Before",id:"before",level:4},{value:"After",id:"after",level:4}],p={toc:c},d="wrapper";function h(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"local-development"},"Local Development"),(0,a.kt)("h2",{id:"setup"},"Setup"),(0,a.kt)("p",null,"For our training example on a local machine, we will be using the nanoGPT ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/karpathy/nanoGPT"},"(https://github.com/karpathy/nanoGPT)")," model by ",(0,a.kt)("a",{parentName:"p",href:"https://karpathy.ai/"},"Andrej Karpathy")," to explain how it works at a basic level. You can follow this step by step video tutorial by non other than Andrej Karpathy ",(0,a.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=kCc8FmEb1nY"},"here")," for an in depth understanding of how this all works or you can read an article by ",(0,a.kt)("a",{parentName:"p",href:"https://www.nytimes.com/interactive/2023/04/26/upshot/gpt-from-scratch.html"},"New York Times")," (or access a PDF of it ",(0,a.kt)("a",{parentName:"p",href:"https://courses.cs.washington.edu/courses/cse473/23sp/uwnetid/lit/Let_Us_GPT.pdf"},"here"),")."),(0,a.kt)("h3",{id:"installing-python"},"Installing Python"),(0,a.kt)("p",null,"First, we have to make sure Python is installed. While the latest python version is Python 3.12, we need Python 3.10. This is because Python 3.10 is the latest python version that supports an important machine learning package ",(0,a.kt)("a",{parentName:"p",href:"https://pytorch.org/"},"PyTorch"),". If you have a lower version python such as Python 3.9 or Python 3.8 it should be fine but will not work for older versions."),(0,a.kt)("h4",{id:"windows"},"Windows"),(0,a.kt)("p",null,"For most machines, make sure to download Windows installed (64-bit) version for Python 3.10.13 ",(0,a.kt)("a",{parentName:"p",href:"https://www.python.org/downloads/windows/"},"[here]")),(0,a.kt)("h4",{id:"macos"},"macOS"),(0,a.kt)("p",null,"For the macOS version, you should download the latest Python 3.10 version which is 3.10.11 ",(0,a.kt)("a",{parentName:"p",href:"https://www.python.org/downloads/macos/"},"[here]")),(0,a.kt)("h4",{id:"linux"},"Linux"),(0,a.kt)("p",null,"You have many options for Linux, ...as always. You could either download directly from the package manager like so"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install python3.10\n")),(0,a.kt)("p",null,"or build directly from source ",(0,a.kt)("a",{parentName:"p",href:"https://www.python.org/downloads/source/"},"[here]")),(0,a.kt)("h3",{id:"copying-code"},"Copying Code"),(0,a.kt)("p",null,"Now that we have Python setup, we should access ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/karpathy/ng-video-lecture/tree/master"},"this")," github repository from Andrej Karpathy to get all the necessary code."),(0,a.kt)("h3",{id:"setting-up-a-virtual-environment"},"Setting up a virtual environment"),(0,a.kt)("p",null,"After you have your python installed and repository cloned, the next step is to make a virtual environment. Inside the directory you downloaded, open your ide of choice from the directory. We use virtual environments to make sure there are no conflicts between package versions. If this is the only python version you have installed, you can just do"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"python3 -m venv venv\n")),(0,a.kt)("p",null,"or if this doesn't work for some reason also try"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"python -m venv venv\n")),(0,a.kt)("p",null,"If you have multiple python versions already installed, you would need to find the location of the executable for the specific python version. So in my case, it would look something like this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"C:/Python310/python.exe -m venv venv\n")),(0,a.kt)("p",null,"This will create a virtual python environment in the current directory called venv."),(0,a.kt)("p",null,"To start the virtual envornment simply type ",(0,a.kt)("inlineCode",{parentName:"p"},"activate")," in the terminal and you should be placed in the virtual environment if you are in the same directory as the venv folder. If this does not work, make sure your terminal is in the current directory and the venv file is also located in the current directory. You can also try"),(0,a.kt)("h4",{id:"windows-1"},"Windows"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},".\\venv\\Scripts\\activate\n")),(0,a.kt)("h4",{id:"macos--linux"},"macOS / Linux"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"source venv/bin/activate\n")),(0,a.kt)("p",null,"To exit the virtual environment, simply type ",(0,a.kt)("inlineCode",{parentName:"p"},"deactivate")," in the termianl or"),(0,a.kt)("h4",{id:"windows-2"},"Windows"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},".\\venv\\Scripts\\deactivate\n")),(0,a.kt)("h4",{id:"macos--linux-1"},"macOS / Linux"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"source venv/bin/deactivate\n")),(0,a.kt)("p",null,"Now that we have our environment setup, we should download the required packages for this demonstration. This part will depend on if you have a dedicated GPU that supports CUDA or not. Go to this ",(0,a.kt)("a",{parentName:"p",href:"https://pytorch.org/"},"website")," and scroll down until you see the ",(0,a.kt)("inlineCode",{parentName:"p"},"install pytorch")," section. Select your options and copy and paste the output inside your virtual environment. This will download the PyTorch package and all the required dependencies."),(0,a.kt)("h2",{id:"training"},"Training"),(0,a.kt)("p",null,"To finally start training, go to the ",(0,a.kt)("inlineCode",{parentName:"p"},"bigram.py")," file and for our first run make sure to lower the ",(0,a.kt)("inlineCode",{parentName:"p"},"max_iters")," parameter from the given 3,000 down to 2,000 for faster results. As you can see from the results, after training for a bit, the model outputs its results. You can mess with the parameters to get better results and you can see the loss go down as the iteration number increases."),(0,a.kt)("h3",{id:"saving-model"},"Saving Model"),(0,a.kt)("p",null,"For bigger models you want to train multiple times or cannot train in a single session, it is important to save your work so that later on, you can load the model and start training again."),(0,a.kt)("p",null,"Pytorch streamlines the process of saving a model by using checkpoints."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"import torch\n\ncheckpoint = {\n    'iter': iter,\n    'model_state_dict': m.state_dict(),\n    'optimizer_state_dict': optimizer.state_dict(),\n    'loss': loss\n    #... other parameters you want to keep\n}\n\ncheckpoint_path = #The path of the checkpoint\n\ntorch.save(checkpoint, checkpoint_path)\n")),(0,a.kt)("p",null,"Loading the model is also straightforward"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"import torch\n\n# Load the checkpoint and create a empty model\nloaded_checkpoint = torch.load(checkpoint_path)\nmodel = BigramLanguageModel()\n\n# Basic setup\ndevice = 'cuda' if torch.cuda.is_available() else 'cpu'\nm = model.to(device)\n\n# Load the model parameters from checkpoint\nm.load_state_dict(loaded_checkpoint['model_state_dict'])\n\n# Create basic optimizer and load from checkpoint\noptimizer = torch.optim.AdamW(m.parameters())\noptimizer.load_state_dict(loaded_checkpoint['optimizer_state_dict'])\n\n# Get vales\niter = loaded_checkpoint['iter']\nloss = loaded_checkpoint['loss']\n\n# Testing to see if model was correctly loaded\nprint(iter)\nprint(loss)\n\ncontext = torch.zeros((1, 1), dtype=torch.long, device=device)\nprint(decode(m.generate(context, max_new_tokens=2000)[0].tolist()))\n")),(0,a.kt)("p",null,"As you can see saving and loading a model allows you to maintain progess and to train bigger models over time."),(0,a.kt)("p",null,"To incorporate this into the nanoGPT training model we are using would look something like this,"),(0,a.kt)("h4",{id:"before"},"Before"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"...\nfor iter in range(max_iters):\n\n    # every once in a while evaluate the loss on train and val sets\n    if iter % eval_interval == 0 or iter == max_iters - 1:\n        losses = estimate_loss()\n        print(f\"step {iter}: train loss {losses['train']:.4f}, val loss {losses['val']:.4f}\")\n\n    # sample a batch of data\n    xb, yb = get_batch('train')\n\n    # evaluate the loss\n    logits, loss = model(xb, yb)\n    optimizer.zero_grad(set_to_none=True)\n    loss.backward()\n    optimizer.step()\n\n# generate from the model\ncontext = torch.zeros((1, 1), dtype=torch.long, device=device)\nprint(decode(m.generate(context, max_new_tokens=2000)[0].tolist()))\n")),(0,a.kt)("h4",{id:"after"},"After"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-py"},"...\ncheckpoint_path = # The path of your checkpoint\n\nfor iter in range(max_iters):\n\n    # save a checkpoint every 100 iteration or if we are at the last iteration\n    if iter % 1000 == 0 or iter == max_iters - 1:\n      checkpoint = {\n        'iter': iter,\n        'model_state_dict': m.state_dict(),\n        'optimizer_state_dict': optimizer.state_dict(),\n        'loss': loss\n    }\n      torch.save(checkpoint, checkpoint_path)\n\n    # every once in a while evaluate the loss on train and val sets\n    if iter % eval_interval == 0 or iter == max_iters - 1:\n        losses = estimate_loss()\n        print(f\"step {iter}: train loss {losses['train']:.4f}, val loss {losses['val']:.4f}\")\n\n    # sample a batch of data\n    xb, yb = get_batch('train')\n\n    # evaluate the loss\n    logits, loss = model(xb, yb)\n    optimizer.zero_grad(set_to_none=True)\n    loss.backward()\n    optimizer.step()\n\n# generate from the model\ncontext = torch.zeros((1, 1), dtype=torch.long, device=device)\nprint(decode(m.generate(context, max_new_tokens=2000)[0].tolist()))\n")))}h.isMDXComponent=!0}}]);